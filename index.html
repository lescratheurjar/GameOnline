<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Shooter.io</title>
  <style>
    body{margin:0;background:#111;color:#fff;font-family:sans-serif;}
    #ui{position:absolute;top:10px;left:10px;z-index:10;}
    #minimap{position:absolute;top:10px;right:10px;width:200px;height:150px;border:2px solid #fff;background:#000;}
    canvas{display:block;margin:auto;background:#222;}
  </style>
</head>
<body>
  <div id="ui">
    <div id="health">Vie: 100</div>
    <div id="score">Score: 0</div>
  </div>
  <canvas id="minimap"></canvas>
  <canvas id="gameCanvas" width="800" height="600"></canvas>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
  const socket = io("https://server-c8jy.onrender.com");
  const cv = document.getElementById("gameCanvas"), ctx = cv.getContext("2d");
  const mm = document.getElementById("minimap"), mmCtx = mm.getContext("2d");
  const uiH = document.getElementById("health");
  const uiS = document.getElementById("score");

  let id, players = {}, bullets = [], MAP, PUs = [];
  let inps = { up:0, down:0, left:0, right:0 }, angle = 0, shootReady = true;

  setInterval(()=>{ socket.emit("move", inps); socket.emit("aim", angle); }, 1000/30);

  window.onkeydown = e => {
    if(e.key=="w") inps.up = 1;
    if(e.key=="s") inps.down = 1;
    if(e.key=="a") inps.left = 1;
    if(e.key=="d") inps.right = 1;
    if(e.key==" " && shootReady){
      shootReady = false;
      socket.emit("shoot");
      setTimeout(()=>shootReady=true, 300);
    }
  };
  window.onkeyup = e => {
    if(e.key=="w") inps.up = 0;
    if(e.key=="s") inps.down = 0;
    if(e.key=="a") inps.left = 0;
    if(e.key=="d") inps.right = 0;
  };

  cv.onmousemove = e => {
    const r = cv.getBoundingClientRect();
    const mx = e.clientX - r.left;
    const my = e.clientY - r.top;
    if(players[id])
      angle = Math.atan2(my - players[id].y, mx - players[id].x);
  };

  socket.on("init", x => id = x);
  socket.on("state", st => {
    players = st.players;
    bullets = st.bullets;
    MAP = st.MAP;
    PUs = st.POWERUPS;
    if(players[id]){
      uiH.textContent = "Vie: " + players[id].health;
      uiS.textContent = "Score: " + players[id].score;
    }
  });

  function draw(){
    ctx.clearRect(0,0,800,600);
    ctx.fillStyle="#555";
    MAP.walls.forEach(w=>ctx.fillRect(w.x,w.y,w.w,w.h));

    for(let pid in players){
      const p = players[pid];
      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.angle);
      ctx.fillStyle = pid == id ? "#0ff" : "#fff";
      ctx.fillRect(-12, -12, 24, 24);
      ctx.restore();
    }

    ctx.fillStyle="#ff0";
    bullets.forEach(b=>{
      ctx.beginPath();
      ctx.arc(b.x,b.y,5,0,Math.PI*2);
      ctx.fill();
    });

    PUs.forEach(pu=>{
      ctx.beginPath();
      ctx.arc(pu.x, pu.y, 10, 0, Math.PI*2);
      ctx.fillStyle = pu.type === "hp" ? "#f00" : "#0f0";
      ctx.fill();
    });

    mmCtx.clearRect(0,0,200,150);
    mmCtx.fillStyle="#333"; mmCtx.fillRect(0,0,200,150);
    for(let pid in players){
      const p = players[pid];
      mmCtx.fillStyle = pid == id ? "#0ff" : "#fff";
      mmCtx.fillRect(p.x/4 - 3, p.y/4 - 3, 6, 6);
    }
    mmCtx.fillStyle="#555";
    MAP.walls.forEach(w=>mmCtx.fillRect(w.x/4, w.y/4, w.w/4, w.h/4));
    PUs.forEach(pu=>{
      mmCtx.fillStyle = pu.type === "hp" ? "#f00" : "#0f0";
      mmCtx.fillRect(pu.x/4 - 4, pu.y/4 - 4, 8, 8);
    });

    requestAnimationFrame(draw);
  }
  draw();
  </script>
</body>
</html>
