<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>2D Top-Down FPS .io</title>
<style>
  body { margin: 0; overflow: hidden; background: #222; color: white; font-family: sans-serif; }
  #gameCanvas { background: #111; display: block; margin: 0 auto; }
  #minimap { position: fixed; top: 10px; right: 10px; border: 2px solid #555; background: #222; }
</style>
</head>
<body>
<canvas id="gameCanvas" width="800" height="600"></canvas>
<canvas id="minimap" width="200" height="150"></canvas>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const minimap = document.getElementById("minimap");
const mmCtx = minimap.getContext("2d");

let id = null;
let players = {};
let bullets = [];
let PUs = [];
let MAP = null;

const socket = io("https://server-c8jy.onrender.com");

document.addEventListener("keydown", e => {
  if(e.repeat) return;
  if(e.key === "w") socket.emit("input", {up:true});
  if(e.key === "s") socket.emit("input", {down:true});
  if(e.key === "a") socket.emit("input", {left:true});
  if(e.key === "d") socket.emit("input", {right:true});
});
document.addEventListener("keyup", e => {
  if(e.key === "w") socket.emit("input", {up:false});
  if(e.key === "s") socket.emit("input", {down:false});
  if(e.key === "a") socket.emit("input", {left:false});
  if(e.key === "d") socket.emit("input", {right:false});
});

canvas.addEventListener("mousemove", e => {
  const rect = canvas.getBoundingClientRect();
  const mouseX = e.clientX - rect.left;
  const mouseY = e.clientY - rect.top;
  socket.emit("aim", {x: mouseX, y: mouseY});
});

canvas.addEventListener("mousedown", e => {
  socket.emit("shoot");
});

socket.on("connect", () => {
  id = socket.id;
});

socket.on("state", state => {
  players = state.players;
  bullets = state.bullets;
  PUs = state.PUs;
  MAP = state.MAP;
});

function draw(){
  if(!MAP) return;

  ctx.clearRect(0,0,800,600);
  ctx.fillStyle="#555";
  MAP.walls.forEach(w=>ctx.fillRect(w.x,w.y,w.w,w.h));

  for(let pid in players){
    const p = players[pid];
    ctx.save();
    ctx.translate(p.x, p.y);
    ctx.rotate(p.angle);
    ctx.fillStyle = pid == id ? "#0ff" : "#fff";
    ctx.fillRect(-12, -12, 24, 24);
    ctx.restore();
  }

  ctx.fillStyle="#ff0";
  bullets.forEach(b=>{
    ctx.beginPath();
    ctx.arc(b.x,b.y,5,0,Math.PI*2);
    ctx.fill();
  });

  PUs.forEach(pu=>{
    ctx.beginPath();
    ctx.arc(pu.x, pu.y, 10, 0, Math.PI*2);
    ctx.fillStyle = pu.type === "hp" ? "#f00" : "#0f0";
    ctx.fill();
  });

  mmCtx.clearRect(0,0,200,150);
  mmCtx.fillStyle="#333"; mmCtx.fillRect(0,0,200,150);
  for(let pid in players){
    const p = players[pid];
    mmCtx.fillStyle = pid == id ? "#0ff" : "#fff";
    mmCtx.fillRect(p.x/4 - 3, p.y/4 - 3, 6, 6);
  }
  mmCtx.fillStyle="#555";
  MAP.walls.forEach(w=>mmCtx.fillRect(w.x/4, w.y/4, w.w/4, w.h/4));
  PUs.forEach(pu=>{
    mmCtx.fillStyle = pu.type === "hp" ? "#f00" : "#0f0";
    mmCtx.fillRect(pu.x/4 - 4, pu.y/4 - 4, 8, 8);
  });

  requestAnimationFrame(draw);
}

draw();
</script>
</body>
</html>
